<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eMojiSync - Web Preview & OBS</title>
    <style>
        :root { 
            --primary: #00f2fe; --accent: #4facfe; --bg-dark: #0a0a0b;
            --panel-bg: #141416; --item-bg: #252529;
            --text-main: #e0e0e0; --text-dim: #71717a;
            --danger: #ff4b2b; --success: #00e676;
            --threshold-color: #ff3e3e;
        }
        
        body { 
            margin: 0; background: var(--bg-dark); color: var(--text-main); 
            font-family: 'Inter', -apple-system, sans-serif; height: 100vh; 
            display: grid; grid-template-columns: 350px 1fr; 
            overflow: hidden;
        }

        /* --- DASHBOARD (LADO ESQUERDO) --- */
        #controles { 
            padding: 20px; border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 12px; overflow-y: auto; 
            z-index: 10;
        }
        
        .brand { 
            font-size: 22px; font-weight: 900; text-align: center;
            background: linear-gradient(to right, var(--primary), var(--accent)); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }

        .secao { 
            display: flex; flex-direction: column; gap: 10px; background: var(--panel-bg); 
            padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);
        }

        .icon-header { font-size: 11px; color: var(--accent); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }

        select, input[type=text] { 
            width: 100%; padding: 10px; background: var(--item-bg); border: 1px solid rgba(255,255,255,0.1); 
            color: white; border-radius: 8px; box-sizing: border-box; font-size: 12px; outline: none;
        }

        /* Meter de √Åudio */
        .meter-container { 
            width: 100%; height: 12px; background: #000; border-radius: 6px; 
            position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
        }
        #meter-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--primary)); transition: width 0.05s; }
        #threshold-marker { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--threshold-color); box-shadow: 0 0 5px var(--threshold-color); z-index: 5; }

        /* Bot√µes */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 10px; transition: 0.3s; }
        button.success { background: var(--success); color: #000; }
        button.danger { background: var(--danger); color: white; }
        button.secondary { background: #333; color: white; }
        
        .btn-obs { background: var(--primary); color: #000; grid-column: span 2; }

        /* Sliders */
        .range-wrapper { display: grid; grid-template-columns: 70px 1fr; align-items: center; gap: 10px; font-size: 11px; color: var(--text-dim); }
        input[type=range] { width: 100%; accent-color: var(--primary); cursor: pointer; }

        /* Presets & Grid */
        .presets-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .btn-preset { padding: 5px 8px; background: var(--item-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--text-dim); border-radius: 4px; cursor: pointer; font-size: 10px; text-transform: none; }
        
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(38px, 1fr)); gap: 6px; }
        .scenario-item { background: var(--item-bg); border-radius: 8px; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; border: 2px solid transparent; }
        .scenario-item.active { border-color: var(--primary); background: rgba(0, 242, 254, 0.15); }

        /* --- VIEWPORT DO AVATAR (LADO DIREITO) --- */
        #viewport { 
            position: relative; overflow: hidden; 
            background: radial-gradient(circle, #1a1a1c 0%, #0a0a0b 100%); 
        }
        canvas { display: block; width: 100%; height: 100%; }
        .hint-obs { position: absolute; bottom: 20px; right: 20px; color: var(--text-dim); font-size: 12px; pointer-events: none; }

        /* Estilo para Modo Somente Avatar (OBS) */
        body.mode-avatar { grid-template-columns: 1fr; }
        body.mode-avatar #controles { display: none; }
        body.mode-avatar #viewport { background: transparent !important; }
    </style>
</head>
<body>

    <div id="controles">
        <div class="brand">eMojiSync</div>
        
        <div class="secao">
            <div class="icon-header">Audio & OBS</div>
            <select id="audioSource" onchange="alterarFonteAudio()"></select>
            <div class="meter-container">
                <div id="meter-fill"></div>
                <div id="threshold-marker"></div>
            </div>
            <div class="btn-group">
                <button id="btnToggle" class="success" onclick="toggleEmoji()">Start Mic</button>
                <button class="secondary" onclick="resetConfig()">Reset</button>
                <button class="btn-obs" onclick="copiarLinkOBS()">üîó Copy OBS Browser Link</button>
            </div>
        </div>

        <div class="secao">
            <div class="icon-header">Expressions</div>
            <input type="text" id="emojiSilencio" value="üòê" placeholder="Idle" oninput="salvarConfig()">
            <input type="text" id="emojiSequencia" value="ü´§üòØüò¶üòßüò≤üòÆü´®" placeholder="Sequence" oninput="salvarConfig()">
            <div class="presets-container">
                <button class="btn-preset" onclick="setPreset('ü´§üòØüò¶üòßüò≤üòÆü´®', 'üòê')">Default</button>
                <button class="btn-preset" onclick="setPreset('üòõüòúü§™üëÖüò±ü§Øü§™üòú', 'ü§ê')">Crazy</button>
                <button class="btn-preset" onclick="setPreset('üê±üò∏üòπüòªüôÄüòΩüòºüò∫', 'üòº')">Cat</button>
                <button class="btn-preset" onclick="setPreset('üò†üò°ü•µü§¨üò´üò≠üò§üò°', 'üò°')">Mad</button>
            </div>
        </div>

        <div class="secao">
            <div class="icon-header">Physics</div>
            <div class="range-wrapper"><span>Thresh.</span><input type="range" id="threshold" min="-60" max="-5" value="-25" oninput="atualizarMarcadorThreshold(); salvarConfig();"></div>
            <div class="range-wrapper"><span>Motion</span><input type="range" id="intensidade" min="0" max="2" step="0.1" value="1" oninput="salvarConfig()"></div>
            <div class="range-wrapper"><span>Zoom</span><input type="range" id="zoom" min="0.3" max="5.0" step="0.1" value="1" oninput="salvarConfig()"></div>
            <div class="range-wrapper"><span>X Axis</span><input type="range" id="posX" min="-500" max="500" value="0" oninput="salvarConfig()"></div>
            <div class="range-wrapper"><span>Y Axis</span><input type="range" id="posY" min="-400" max="400" value="0" oninput="salvarConfig()"></div>
        </div>

        <div class="secao">
            <div class="icon-header">Background</div>
            <div class="scenario-grid" id="bgGrid">
                <div id="no-bg" class="scenario-item active" onclick="setBg(this, '')">‚ùå</div>
            </div>
        </div>
    </div>

    <div id="viewport">
        <canvas id="avatarCanvas"></canvas>
        <div class="hint-obs">Preview Mode</div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO INICIAL E ROTEAMENTO ---
        const urlParams = new URLSearchParams(window.location.search);
        const isAvatarView = urlParams.has('view');
        if (isAvatarView) document.body.classList.add('mode-avatar');

        let selectedBg = "", volumeSuave = 0, analyser, dataArray, audioStream, audioCtx;
        let emojiAtivo = false, frameCount = 0;
        const canvas = document.getElementById('avatarCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        window.onresize = resize;
        resize();

        // --- GEST√ÉO DE √ÅUDIO ---
        async function listarFontes() {
            try {
                if(!isAvatarView) await navigator.mediaDevices.getUserMedia({ audio: true });
                const dispositivos = await navigator.mediaDevices.enumerateDevices();
                const select = document.getElementById('audioSource');
                select.innerHTML = '';
                dispositivos.forEach(dev => {
                    if (dev.kind === 'audioinput') {
                        const opt = document.createElement('option');
                        opt.value = dev.deviceId;
                        opt.text = dev.label || `Mic ${select.length + 1}`;
                        select.appendChild(opt);
                    }
                });
                carregarConfig();
            } catch (e) { console.log("Aguardando intera√ß√£o para √°udio."); }
        }

        async function iniciarAudio() {
            if (audioStream) audioStream.getTracks().forEach(t => t.stop());
            const config = JSON.parse(localStorage.getItem('emojiSyncWeb') || '{}');
            const deviceId = config.deviceId || document.getElementById('audioSource').value;
            
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: deviceId ? { exact: deviceId } : true 
                });
                const source = audioCtx.createMediaStreamSource(audioStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 128;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                emojiAtivo = true;
            } catch (e) { alert("Erro ao acessar microfone. Verifique as permiss√µes."); }
        }

        function toggleEmoji() {
            if (!emojiAtivo) {
                iniciarAudio();
                document.getElementById('btnToggle').textContent = "Stop Mic";
                document.getElementById('btnToggle').className = "danger";
            } else {
                emojiAtivo = false;
                if (audioStream) audioStream.getTracks().forEach(t => t.stop());
                document.getElementById('btnToggle').textContent = "Start Mic";
                document.getElementById('btnToggle').className = "success";
                volumeSuave = 0;
            }
        }

        // --- MOTOR DE RENDERIZA√á√ÉO ---
        let rotation_atual = 0, noiseOffset = 0;

        function loop() {
            requestAnimationFrame(loop);
            const config = JSON.parse(localStorage.getItem('emojiSyncWeb') || '{}');

            if (emojiAtivo && analyser) {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<dataArray.length; i++) sum += dataArray[i]*dataArray[i];
                let rms = Math.sqrt(sum / dataArray.length);
                let db = 20 * Math.log10(rms / 255 || 0.00001);
                
                const thresh = parseFloat(config.threshold || -25);
                let volMapeado = (db > thresh) ? (db - thresh) / (Math.abs(thresh) || 1) * 160 : 0;
                volumeSuave += (volMapeado - volumeSuave) * 0.25;

                if (!isAvatarView) {
                    let visualVol = ((db + 60) / 55) * 100;
                    document.getElementById('meter-fill').style.width = Math.min(100, Math.max(0, visualVol)) + "%";
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const z = parseFloat(config.zoom || 1), m = parseFloat(config.intensidade || 1);
            const pX = parseFloat(config.posX || 0), pY = parseFloat(config.posY || 0);

            if (config.bg) {
                ctx.save();
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.font = "400px sans-serif"; ctx.globalAlpha = 0.2;
                ctx.fillText(config.bg, canvas.width/2, canvas.height/2);
                ctx.restore();
            }

            if (emojiAtivo) {
                let char = config.silencio || "üòê";
                if (volumeSuave > 2) {
                    const seq = [...(config.sequencia || "ü´§üòØüò¶üòßüò≤üòÆü´®")];
                    char = seq[Math.floor(frameCount/15) % seq.length] || char;
                    frameCount++;
                } else { frameCount = 0; }

                noiseOffset += 0.05 * m;
                let jump = (volumeSuave * 8 * z * m);
                let balancoX = Math.sin(noiseOffset * 0.5) * (5 * z * m);
                
                ctx.save();
                ctx.translate(canvas.width/2 + pX + balancoX, canvas.height/2 + pY - jump);
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.font = (250 * z) + "px sans-serif";
                ctx.fillText(char, 0, 0);
                ctx.restore();
            }
        }

        // --- FUN√á√ïES AUXILIARES ---
        function copiarLinkOBS() {
            const url = window.location.origin + window.location.pathname + '?view=avatar';
            navigator.clipboard.writeText(url);
            alert("Link para o OBS copiado!");
        }

        function setPreset(seq, idle) {
            document.getElementById('emojiSequencia').value = seq;
            document.getElementById('emojiSilencio').value = idle;
            salvarConfig();
        }

        function setBg(el, char) {
            selectedBg = char;
            document.querySelectorAll('.scenario-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            salvarConfig();
        }

        function salvarConfig() {
            if (isAvatarView) return;
            const config = {
                threshold: document.getElementById('threshold').value,
                intensidade: document.getElementById('intensidade').value,
                zoom: document.getElementById('zoom').value,
                posX: document.getElementById('posX').value,
                posY: document.getElementById('posY').value,
                silencio: document.getElementById('emojiSilencio').value,
                sequencia: document.getElementById('emojiSequencia').value,
                bg: selectedBg,
                deviceId: document.getElementById('audioSource').value
            };
            localStorage.setItem('emojiSyncWeb', JSON.stringify(config));
        }

        function carregarConfig() {
            const s = localStorage.getItem('emojiSyncWeb');
            if(s) {
                const c = JSON.parse(s);
                if(!isAvatarView) {
                    document.getElementById('threshold').value = c.threshold || -25;
                    document.getElementById('intensidade').value = c.intensidade || 1;
                    document.getElementById('zoom').value = c.zoom || 1;
                    document.getElementById('posX').value = c.posX || 0;
                    document.getElementById('posY').value = c.posY || 0;
                    document.getElementById('emojiSilencio').value = c.silencio || "üòê";
                    document.getElementById('emojiSequencia').value = c.sequencia || "ü´§üòØüò¶üòßüò≤üòÆü´®";
                    document.getElementById('audioSource').value = c.deviceId || "";
                }
                selectedBg = c.bg || "";
                atualizarMarcadorThreshold();
            }
        }

        function atualizarMarcadorThreshold() {
            if (isAvatarView) return;
            const input = document.getElementById('threshold');
            const percent = ((input.value - input.min) / (input.max - input.min)) * 100;
            document.getElementById('threshold-marker').style.left = percent + "%";
        }

        function resetConfig() {
            localStorage.removeItem('emojiSyncWeb');
            location.reload();
        }

        // --- INICIALIZA√á√ÉO ---
        const scenes = ["‚òÄÔ∏è", "‚òÅÔ∏è", "‚õàÔ∏è", "üåä", "üî•", "üèôÔ∏è", "üåÜ", "üåå", "üåà", "‚õ©Ô∏è", "üõ∏", "üíÄ"];
        scenes.forEach(s => {
            const d = document.createElement('div'); d.className = 'scenario-item'; d.textContent = s;
            d.onclick = () => setBg(d, s);
            document.getElementById('bgGrid').appendChild(d);
        });

        if (isAvatarView) {
            window.onclick = iniciarAudio;
            carregarConfig();
        } else {
            listarFontes();
        }
        
        loop();
    </script>
</body>
</html>
